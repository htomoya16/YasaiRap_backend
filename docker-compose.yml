name: yasairap

volumes:
  postgres_data:
  go_build_cache:   # dev の go build キャッシュ
  go_mod_cache:     # dev の go mod キャッシュ

networks:
  yasairap_network:
    driver: bridge

services:
  postgres:
    image: postgres:16-alpine
    container_name: yasairap_postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      TZ: ${POSTGRES_TZ:-UTC}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - yasairap_network

  # 本番（Dockerfile のステージ: prod）
  app:
    profiles: ["prod"]
    build:
      context: .
      target: prod
    container_name: yasairap_backend
    depends_on:
      - postgres
    environment:
      # Discord bot用
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_APP_ID: ${DISCORD_APP_ID}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID}
      # VRCHAT API用
      YASAIRAP_CONTACT_EMAIL: ${YASAIRAP_CONTACT_EMAIL}
      VRCHAT_USERNAME: ${VRCHAT_USERNAME}
      VRCHAT_PASSWORD: ${VRCHAT_PASSWORD}
      VRCHAT_TOTP_SECRET: ${VRCHAT_TOTP_SECRET}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      PORT: ${APP_PORT:-8080}
    ports:
      - "${APP_PORT:-8080}:8080"
    networks: [yasairap_network]
    restart: unless-stopped

  # 開発（Dockerfile のステージ: dev）
  app-dev:
    profiles: ["dev"]
    build:
      context: .
      target: dev
    container_name: yasairap_dev_backend
    depends_on:
      - postgres
    environment:
      # Discord bot用
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_APP_ID: ${DISCORD_APP_ID}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID}
      # VRCHAT API用
      YASAIRAP_CONTACT_EMAIL: ${YASAIRAP_CONTACT_EMAIL}
      VRCHAT_USERNAME: ${VRCHAT_USERNAME}
      VRCHAT_PASSWORD: ${VRCHAT_PASSWORD}
      VRCHAT_TOTP_SECRET: ${VRCHAT_TOTP_SECRET}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      PORT: ${APP_PORT:-8080}
    ports:
      - "${APP_PORT:-8080}:8080"
    # airに必要 ボリュームをマウント
    volumes:
      - .:/app
      - go_build_cache:/root/.cache/go-build
      - go_mod_cache:/go/pkg/mod
    networks: [yasairap_network]
    restart: unless-stopped
